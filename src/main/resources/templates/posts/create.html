<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>새 게시글 작성 - 과제 제출 시스템</title>

  <!-- Bootstrap 5.3 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-color: #4F46E5;
      --primary-dark: #3730A3;
      --secondary-color: #10B981;
      --danger-color: #EF4444;
      --warning-color: #F59E0B;
      --info-color: #06B6D4;
      --light-bg: #F8FAFC;
      --dark-text: #1E293B;
      --medium-text: #64748B;
      --border-color: #E2E8F0;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }

    * {
      font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      background-color: var(--light-bg);
      color: var(--dark-text);
      line-height: 1.6;
    }

    /* 네비게이션 스타일 */
    .navbar {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      box-shadow: var(--shadow-md);
      padding: 1rem 0;
    }

    .navbar-brand {
      font-weight: 700;
      font-size: 1.5rem;
      color: white !important;
    }

    .navbar-nav .nav-link {
      color: rgba(255, 255, 255, 0.9) !important;
      font-weight: 500;
      margin: 0 0.5rem;
      padding: 0.5rem 1rem !important;
      border-radius: 0.5rem;
      transition: all 0.3s ease;
    }

    .navbar-nav .nav-link:hover {
      background-color: rgba(255, 255, 255, 0.1);
      color: white !important;
    }

    .navbar-nav .nav-link.active {
      background-color: rgba(255, 255, 255, 0.2);
      color: white !important;
    }

    .btn-logout {
      background-color: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white !important;
      font-size: 0.9rem;
      padding: 0.4rem 1rem;
      border-radius: 0.5rem;
      transition: all 0.3s ease;
    }

    .btn-logout:hover {
      background-color: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
      color: white !important;
    }

    /* 메인 컨텐츠 */
    .main-container {
      padding: 2rem 0;
      min-height: calc(100vh - 140px);
    }

    /* 페이지 헤더 */
    .page-header {
      background: white;
      border-radius: 1rem;
      box-shadow: var(--shadow-sm);
      padding: 2rem;
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
    }

    .page-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--dark-text);
      margin-bottom: 0.5rem;
    }

    .page-subtitle {
      color: var(--medium-text);
      font-size: 1.1rem;
    }

    /* 폼 카드 */
    .form-card {
      background: white;
      border-radius: 1rem;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
      overflow: hidden;
    }

    .form-card-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 1.5rem 2rem;
    }

    .form-card-header h4 {
      margin: 0;
      font-weight: 600;
    }

    .form-card-body {
      padding: 2rem;
    }

    /* 폼 스타일 */
    .form-label {
      font-weight: 600;
      color: var(--dark-text);
      margin-bottom: 0.75rem;
    }

    .required {
      color: var(--danger-color);
    }

    .form-control, .form-select {
      border: 2px solid var(--border-color);
      border-radius: 0.75rem;
      padding: 0.875rem 1rem;
      font-size: 1rem;
      transition: all 0.3s ease;
      background-color: #FAFBFC;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(79, 70, 229, 0.1);
      background-color: white;
    }

    textarea.form-control {
      min-height: 200px;
      resize: vertical;
    }

    .form-text {
      color: var(--medium-text);
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }

    /* 파일 업로드 */
    .file-upload-area {
      border: 2px dashed var(--border-color);
      border-radius: 1rem;
      padding: 2rem;
      text-align: center;
      background-color: #FAFBFC;
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }

    .file-upload-area:hover {
      border-color: var(--primary-color);
      background-color: rgba(79, 70, 229, 0.05);
    }

    .file-upload-area.dragover {
      border-color: var(--primary-color);
      background-color: rgba(79, 70, 229, 0.1);
    }

    .file-upload-icon {
      font-size: 3rem;
      color: var(--medium-text);
      margin-bottom: 1rem;
    }

    .file-upload-text {
      color: var(--dark-text);
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .file-upload-hint {
      color: var(--medium-text);
      font-size: 0.9rem;
    }

    .file-input {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .selected-files {
      margin-top: 1rem;
    }

    .file-item {
      background-color: white;
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: between;
    }

    .file-info {
      display: flex;
      align-items: center;
      flex: 1;
    }

    .file-icon {
      margin-right: 1rem;
      color: var(--primary-color);
    }

    .file-name {
      font-weight: 500;
      margin-bottom: 0.25rem;
    }

    .file-size {
      color: var(--medium-text);
      font-size: 0.875rem;
    }

    .btn-remove-file {
      background: none;
      border: none;
      color: var(--danger-color);
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 0.25rem;
      transition: all 0.3s ease;
    }

    .btn-remove-file:hover {
      background-color: rgba(239, 68, 68, 0.1);
    }

    /* 버튼 스타일 */
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      border: none;
      border-radius: 0.75rem;
      padding: 0.875rem 2rem;
      font-weight: 600;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
    }

    .btn-outline-secondary {
      border: 2px solid var(--border-color);
      color: var(--medium-text);
      background: white;
      border-radius: 0.75rem;
      padding: 0.875rem 2rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-outline-secondary:hover {
      background-color: var(--light-bg);
      border-color: var(--medium-text);
      color: var(--dark-text);
    }

    /* 타입 선택 */
    .type-selection {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .type-option {
      flex: 1;
      position: relative;
    }

    .type-option input[type="radio"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
      margin: 0;
    }

    .type-option label {
      display: block;
      padding: 1rem;
      border: 2px solid var(--border-color);
      border-radius: 0.75rem;
      text-align: center;
      font-weight: 500;
      transition: all 0.3s ease;
      cursor: pointer;
      background-color: #FAFBFC;
    }

    .type-option input[type="radio"]:checked + label {
      border-color: var(--primary-color);
      background-color: rgba(79, 70, 229, 0.1);
      color: var(--primary-color);
    }

    .type-option.assignment input[type="radio"]:checked + label {
      border-color: var(--primary-color);
      background-color: rgba(79, 70, 229, 0.1);
    }

    .type-option.notice input[type="radio"]:checked + label {
      border-color: var(--warning-color);
      background-color: rgba(245, 158, 11, 0.1);
      color: var(--warning-color);
    }

    .type-option.general input[type="radio"]:checked + label {
      border-color: var(--secondary-color);
      background-color: rgba(16, 185, 129, 0.1);
      color: var(--secondary-color);
    }

    .type-option label i {
      display: block;
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    /* 알림 스타일 */
    .alert {
      border: none;
      border-radius: 0.75rem;
      padding: 1rem 1.5rem;
      margin-bottom: 1.5rem;
      font-weight: 500;
    }

    .alert-success {
      background-color: #ECFDF5;
      color: #065F46;
      border-left: 4px solid var(--secondary-color);
    }

    .alert-danger {
      background-color: #FEF2F2;
      color: #991B1B;
      border-left: 4px solid var(--danger-color);
    }

    /* 반응형 */
    @media (max-width: 768px) {
      .main-container {
        padding: 1rem 0;
      }

      .page-header {
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .page-title {
        font-size: 1.5rem;
      }

      .form-card-body {
        padding: 1.5rem;
      }

      .type-selection {
        flex-direction: column;
        gap: 0.75rem;
      }

      .file-upload-area {
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>
<!-- 네비게이션 -->
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand" href="/" th:href="@{/}">
      <i class="fas fa-graduation-cap me-2"></i>과제 제출 시스템
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <a class="nav-link" th:href="@{/}">
            <i class="fas fa-home me-1"></i>홈
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" th:href="@{/dashboard}">
            <i class="fas fa-tachometer-alt me-1"></i>대시보드
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" th:href="@{/posts}">
            <i class="fas fa-list-alt me-1"></i>게시글
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link active">
            <i class="fas fa-plus me-1"></i>과제 등록
          </a>
        </li>
      </ul>

      <ul class="navbar-nav ms-auto">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
            <i class="fas fa-user me-1"></i>
            <span sec:authentication="name">사용자</span>
          </a>
          <ul class="dropdown-menu">
            <li>
              <a class="dropdown-item" th:href="@{/profile}">
                <i class="fas fa-user-circle me-2"></i>내 프로필
              </a>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li>
              <form method="post" th:action="@{/logout}" class="d-inline">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="btn btn-logout w-100 text-start">
                  <i class="fas fa-sign-out-alt me-2"></i>로그아웃
                </button>
              </form>
            </li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- 메인 컨텐츠 -->
<div class="main-container">
  <div class="container">
    <!-- 페이지 헤더 -->
    <div class="page-header">
      <h1 class="page-title">
        <i class="fas fa-plus-circle me-3" style="color: var(--primary-color);"></i>
        새 게시글 작성
      </h1>
      <p class="page-subtitle">새로운 과제나 공지사항을 등록하세요</p>
    </div>

    <!-- 알림 메시지 -->
    <div th:if="${success}" class="alert alert-success">
      <i class="fas fa-check-circle me-2"></i>
      <span th:text="${success}">성공 메시지</span>
    </div>

    <div th:if="${error}" class="alert alert-danger">
      <i class="fas fa-exclamation-circle me-2"></i>
      <span th:text="${error}">오류 메시지</span>
    </div>

    <!-- 폼 카드 -->
    <div class="form-card">
      <div class="form-card-header">
        <h4>
          <i class="fas fa-edit me-2"></i>게시글 정보
        </h4>
      </div>

      <div class="form-card-body">
        <form method="post" th:action="@{/posts/create}" th:object="${post}" enctype="multipart/form-data" id="createForm">

          <!-- 제목 -->
          <div class="mb-4">
            <label for="title" class="form-label">
              제목 <span class="required">*</span>
            </label>
            <input type="text"
                   class="form-control"
                   id="title"
                   th:field="*{title}"
                   placeholder="게시글 제목을 입력하세요"
                   required>
            <div th:if="${#fields.hasErrors('title')}"
                 class="text-danger mt-2"
                 th:errors="*{title}"></div>
          </div>

          <!-- 게시글 유형 -->
          <div class="mb-4">
            <label class="form-label">게시글 유형 <span class="required">*</span></label>
            <div class="type-selection">
              <div class="type-option assignment">
                <input type="radio" id="assignment" th:field="*{type}" value="ASSIGNMENT" required>
                <label for="assignment">
                  <i class="fas fa-tasks"></i>
                  과제
                </label>
              </div>
              <div class="type-option notice">
                <input type="radio" id="notice" th:field="*{type}" value="NOTICE">
                <label for="notice">
                  <i class="fas fa-bullhorn"></i>
                  공지사항
                </label>
              </div>
              <div class="type-option general">
                <input type="radio" id="general" th:field="*{type}" value="GENERAL">
                <label for="general">
                  <i class="fas fa-comment"></i>
                  일반
                </label>
              </div>
            </div>
          </div>

          <!-- 마감일 (과제인 경우) -->
          <div class="mb-4" id="dueDateSection" style="display: none;">
            <label for="dueDate" class="form-label">
              마감일
            </label>
            <input type="datetime-local"
                   class="form-control"
                   id="dueDate"
                   th:field="*{dueDate}">
            <div class="form-text">과제 제출 마감일을 설정하세요</div>
          </div>

          <!-- 내용 -->
          <div class="mb-4">
            <label for="content" class="form-label">
              내용 <span class="required">*</span>
            </label>
            <textarea class="form-control"
                      id="content"
                      th:field="*{content}"
                      placeholder="게시글 내용을 입력하세요"
                      rows="12"
                      required></textarea>
            <div th:if="${#fields.hasErrors('content')}"
                 class="text-danger mt-2"
                 th:errors="*{content}"></div>
          </div>

          <!-- 첨부 파일 -->
          <div class="mb-4">
            <label class="form-label">첨부 파일</label>
            <div class="file-upload-area" id="fileUploadArea">
              <input type="file"
                     name="files"
                     id="fileInput"
                     class="file-input"
                     multiple
                     accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.zip,.rar">
              <div class="file-upload-icon">
                <i class="fas fa-cloud-upload-alt"></i>
              </div>
              <div class="file-upload-text">파일을 드래그하거나 클릭하여 선택하세요</div>
              <div class="file-upload-hint">과제 자료나 참고 파일을 첨부할 수 있습니다. (최대 10MB)</div>
            </div>

            <div id="selectedFiles" class="selected-files"></div>
          </div>

          <!-- 버튼 영역 -->
          <div class="d-flex gap-3 justify-content-end">
            <a href="/posts" th:href="@{/posts}" class="btn btn-outline-secondary">
              <i class="fas fa-times me-2"></i>취소
            </a>
            <button type="submit" class="btn btn-primary" id="submitBtn">
              <i class="fas fa-save me-2"></i>등록하기
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap 5.3 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const typeRadios = document.querySelectorAll('input[name="type"]');
    const dueDateSection = document.getElementById('dueDateSection');
    const fileInput = document.getElementById('fileInput');
    const fileUploadArea = document.getElementById('fileUploadArea');
    const selectedFilesDiv = document.getElementById('selectedFiles');
    let selectedFiles = [];

    // 게시글 유형에 따른 마감일 섹션 표시/숨김
    typeRadios.forEach(radio => {
      radio.addEventListener('change', function() {
        if (this.value === 'ASSIGNMENT') {
          dueDateSection.style.display = 'block';
        } else {
          dueDateSection.style.display = 'none';
          document.getElementById('dueDate').value = '';
        }
      });
    });

    // 파일 드래그 앤 드롭
    fileUploadArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      this.classList.add('dragover');
    });

    fileUploadArea.addEventListener('dragleave', function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
    });

    fileUploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      this.classList.remove('dragover');

      const files = Array.from(e.dataTransfer.files);
      handleFileSelection(files);
    });

    // 파일 선택
    fileInput.addEventListener('change', function(e) {
      const files = Array.from(e.target.files);
      handleFileSelection(files);
    });

    // 파일 처리 함수
    function handleFileSelection(files) {
      files.forEach(file => {
        if (file.size > 10 * 1024 * 1024) { // 10MB 제한
          alert(`${file.name} 파일이 10MB를 초과합니다.`);
          return;
        }

        if (!selectedFiles.some(f => f.name === file.name)) {
          selectedFiles.push(file);
        }
      });

      displaySelectedFiles();
      updateFileInput();
    }

    // 선택된 파일 표시
    function displaySelectedFiles() {
      selectedFilesDiv.innerHTML = '';

      selectedFiles.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';

        fileItem.innerHTML = `
                        <div class="file-info">
                            <i class="fas fa-file file-icon"></i>
                            <div>
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">${formatFileSize(file.size)}</div>
                            </div>
                        </div>
                        <button type="button" class="btn-remove-file" onclick="removeFile(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;

        selectedFilesDiv.appendChild(fileItem);
      });
    }

    // 파일 제거
    window.removeFile = function(index) {
      selectedFiles.splice(index, 1);
      displaySelectedFiles();
      updateFileInput();
    };

    // 파일 input 업데이트
    function updateFileInput() {
      const dt = new DataTransfer();
      selectedFiles.forEach(file => dt.items.add(file));
      fileInput.files = dt.files;
    }

    // 파일 크기 포맷팅
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 폼 제출
    const createForm = document.getElementById('createForm');
    const submitBtn = document.getElementById('submitBtn');

    createForm.addEventListener('submit', function(e) {
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>등록 중...';
      submitBtn.disabled = true;
    });

    // 내용 자동 크기 조정
    const contentTextarea = document.getElementById('content');
    contentTextarea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = this.scrollHeight + 'px';
    });
  });
</script>
</body>
</html>